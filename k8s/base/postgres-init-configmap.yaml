apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-db
  namespace: iot-meter
  labels:
    app: postgres
    app.kubernetes.io/part-of: iot-meter
data:
  init-db.sql: |
    -- Device metadata table
    -- See IoT.md §11 — devices must be registered before first use.
    CREATE TABLE IF NOT EXISTS devices (
        id SERIAL PRIMARY KEY,
        device_id VARCHAR(255) UNIQUE NOT NULL,
        device_name VARCHAR(255) NOT NULL,
        device_type VARCHAR(100),
        location VARCHAR(255),
        status VARCHAR(50) DEFAULT 'active',
        connection_status VARCHAR(20) DEFAULT 'unknown',
        last_seen TIMESTAMP,
        fw_version VARCHAR(50),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        metadata JSONB
    );

    CREATE INDEX IF NOT EXISTS idx_device_id ON devices(device_id);
    CREATE INDEX IF NOT EXISTS idx_status ON devices(status);
    CREATE INDEX IF NOT EXISTS idx_last_seen ON devices(last_seen);
    CREATE INDEX IF NOT EXISTS idx_connection_status ON devices(connection_status);

    CREATE TABLE IF NOT EXISTS device_configs (
        id SERIAL PRIMARY KEY,
        device_id VARCHAR(255) NOT NULL,
        config_key VARCHAR(255) NOT NULL,
        config_value TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (device_id) REFERENCES devices(device_id) ON DELETE CASCADE,
        UNIQUE(device_id, config_key)
    );

    CREATE TABLE IF NOT EXISTS device_alerts (
        id SERIAL PRIMARY KEY,
        device_id VARCHAR(255) NOT NULL,
        alert_type VARCHAR(100) NOT NULL,
        severity VARCHAR(50),
        message TEXT,
        acknowledged BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (device_id) REFERENCES devices(device_id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_device_alerts_device ON device_alerts(device_id);
    CREATE INDEX IF NOT EXISTS idx_device_alerts_acknowledged ON device_alerts(acknowledged);

    CREATE TABLE IF NOT EXISTS device_commands (
        id SERIAL PRIMARY KEY,
        cmd_id UUID UNIQUE NOT NULL,
        device_id VARCHAR(255) NOT NULL,
        cmd VARCHAR(100) NOT NULL,
        params JSONB DEFAULT '{}',
        status VARCHAR(50) DEFAULT 'pending',
        ack_detail TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        acked_at TIMESTAMP,
        FOREIGN KEY (device_id) REFERENCES devices(device_id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_device_commands_device ON device_commands(device_id);
    CREATE INDEX IF NOT EXISTS idx_device_commands_status ON device_commands(status);

    CREATE TABLE IF NOT EXISTS device_seq_tracking (
        device_id VARCHAR(255) PRIMARY KEY,
        last_seq BIGINT DEFAULT -1,
        gap_count INTEGER DEFAULT 0,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (device_id) REFERENCES devices(device_id) ON DELETE CASCADE
    );

    INSERT INTO devices (device_id, device_name, device_type, location, metadata)
    VALUES
        ('dc-meter-001', 'DC Traction Meter — Train 4521, Car 1', 'power_meter_dc', 'Train 4521 / Car 1 / Main DC Bus',
         '{"voltage_system": "DC 750V", "voltage_range": "0-1000V", "current_range": "0-2000A", "accuracy_class": "0.5R", "sampling_cadence_ms": 1000, "send_interval_s": 10, "hello_interval_s": 30, "brokers": [{"host": "localhost", "port": 1883}]}'),
        ('dc-meter-002', 'DC Traction Meter — Train 4521, Car 3', 'power_meter_dc', 'Train 4521 / Car 3 / Main DC Bus',
         '{"voltage_system": "DC 750V", "voltage_range": "0-1000V", "current_range": "0-2000A", "accuracy_class": "0.5R", "sampling_cadence_ms": 1000, "send_interval_s": 10, "hello_interval_s": 30, "brokers": [{"host": "localhost", "port": 1883}]}'),
        ('ac-meter-001', 'AC Traction Meter — Train 8010, Car 1', 'power_meter_ac', 'Train 8010 / Car 1 / Pantograph',
         '{"voltage_system": "AC 25kV 50Hz", "voltage_range": "0-30000V", "current_range": "0-2000A", "accuracy_class": "0.5R", "sampling_cadence_ms": 1000, "send_interval_s": 10, "hello_interval_s": 30, "brokers": [{"host": "localhost", "port": 1883}]}')
    ON CONFLICT (device_id) DO NOTHING;
